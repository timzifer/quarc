cycle: 500ms
logging:
  level: info
  format: text
modules:
  - example-config.d
dsl:
  allow_if_blocks: true
helpers:
  - name: water_viscosity
    arguments: [temperature_c]
    expression: |
      if temperature_c < 0 {
        fail("helper.temperature", "below freezing")
      } else if temperature_c > 100 {
        fail("helper.temperature", "too hot")
      } else {
        success(temperature_c * 0.001)
      }
cells:
  - id: raw_temperature
    type: number
    unit: counts
  - id: temperature_c
    type: number
    unit: "Â°C"
  - id: heater_enabled
    type: bool
    constant: true
  - id: heater_command
    type: bool
reads:
  - id: temperature_sensor
    endpoint:
      address: "192.168.10.10:502"
      unit_id: 1
    function: holding
    start: 0
    length: 1
    ttl: 1s
    signals:
      - cell: raw_temperature
        offset: 0
        type: number
        scale: 0.1
writes:
  - id: heater_output
    cell: heater_command
    endpoint:
      address: "192.168.10.20:502"
      unit_id: 1
    function: coil
    address: 5
    rate_limit: 2s
    priority: 10
logic:
  - id: convert_temperature
    target: temperature_c
    normal: |
      success(value("raw_temperature"))
    fallback: |
      success(0)
  - id: pid_setpoint_schedule
    target: pid_setpoint
    normal: |
      success(
        value("sequencer_active") == "Heat" ? 65 :
        value("sequencer_active") == "Hold" ? 60 :
        value("sequencer_active") == "Drain" ? 45 :
        50
      )
    fallback: |
      success(50)
  - id: pid_measurement_feedback
    target: pid_process
    normal: |
      success(value("temperature_c"))
    fallback: |
      success(valid("temperature_c") ? value("temperature_c") : fail("logic.dependency", "temperature unavailable"))
  - id: heater_control
    target: heater_command
    normal: |
      success(
        !value("heater_enabled") ? false :
        value("alarm_state") ? false :
        value("pid_output") >= 60 ? true :
        value("pid_output") <= 40 ? false :
        fallback()
      )
    fallback: |
      success(
        valid("pid_output") ? value("pid_output") > 50 :
        fail("logic.dependency", "pid output unavailable")
      )
server:
  enabled: true
  listen: ":15020"
  unit_id: 1
  cells:
    - cell: temperature_c
      address: 0
      scale: 0.1
    - cell: heater_enabled
      address: 1
